<form [formGroup]="formLiquidation">

  <div class="grid">
    <div class="col-12">
      <p-dialog [(visible)]="openModal" styleClass="w-10" [header]="tittleForm" [modal]="true" class="p-fluid">
        <ng-template pTemplate="content">

          <app-message-required-field></app-message-required-field>

          <div class="grid">
            <div class="form-group field mt-3 col-6">
              <p-float-label>
                <p-select
                  inputId="liquidationType"
                  formControlName="liquidationType"
                  [options]="liquidationTypes | keyvalue"
                  optionLabel="value"
                  optionValue="value"
                  [filter]="true"
                  filterBy="value"
                  styleClass="w-full"
                  appendTo="body"
                ></p-select>
                <label for="liquidationType" class="text-lg font-bold text-800 required-field"> {{ labels.liquidationType }} </label>
              </p-float-label>
            </div>
            
            <div class="form-group field mt-3 col-6">
              <p-float-label>
                <p-select
                  inputId="loadId"
                  formControlName="loadId"
                  [options]="loads"
                  optionLabel="correlativeLotCode"
                  optionValue="id"
                  [filter]="true"
                  filterBy="value"
                  styleClass="w-full"
                  appendTo="body"
                ></p-select>
                <label for="loadId" class="text-lg font-bold text-800 required-field"> {{ labels.loads }} </label>
              </p-float-label>
            </div>
  
            <div class="form-group field mt-5 col-6">
              <p-float-label>
                <p-datepicker 
                  id="admissionDate"
                  styleClass="w-full"
                  [showIcon]="true"
                  dateFormat="dd/mm/yy"
                  appendTo="body"
                  formControlName="admissionDate">
                </p-datepicker >
                <label htmlFor="admissionDate" class="text-lg font-bold text-800 required-field"> {{ labels.admissionDate }} </label>
              </p-float-label>
            </div>
  
            <div class="form-group field mt-5 col-6">
              <p-float-label>
                <p-datepicker 
                  id="liquidationDate"
                  styleClass="w-full"
                  [showIcon]="true"
                  dateFormat="dd/mm/yy"
                  appendTo="body"
                  formControlName="liquidationDate">
                </p-datepicker >
                <label htmlFor="liquidationDate" class="text-lg font-bold text-800 required-field"> {{ labels.liquidationDate }} </label>
              </p-float-label>
            </div>
            
            <div class="form-group field mt-3 col-6">
              <p-float-label>
                <p-select
                  inputId="supplierId"
                  formControlName="supplierId"
                  [options]="suppliers"
                  optionLabel="name"
                  optionValue="id"
                  [filter]="true"
                  filterBy="value"
                  styleClass="w-full"
                  appendTo="body"
                ></p-select>
                <label for="supplierId" class="text-lg font-bold text-800 required-field"> {{ labels.supplier }} </label>
              </p-float-label>
            </div>
            
            <div class="form-group field mt-3 col-6">
              <p-float-label>
                <p-select
                  inputId="cooperativeId"
                  formControlName="cooperativeId"
                  [options]="cooperatives"
                  optionLabel="name"
                  optionValue="id"
                  [filter]="true"
                  filterBy="value"
                  styleClass="w-full"
                  appendTo="body"
                ></p-select>
                <label for="cooperativeId" class="text-lg font-bold text-800 required-field"> {{ labels.cooperative }} </label>
              </p-float-label>
            </div>
  
            <div class="form-group field mt-3 col-6">
              <p-float-label>
                <p-select
                  inputId="mineId"
                  formControlName="mineId"
                  [options]="mines"
                  optionLabel="name"
                  optionValue="id"
                  [filter]="true"
                  filterBy="value"
                  styleClass="w-full"
                  appendTo="body"
                ></p-select>
                <label for="mineId" class="text-lg font-bold text-800 required-field"> {{ labels.mine }} </label>
              </p-float-label>
            </div>
  
          </div>
          <div class="grid">
            <div class="form-group field mt-3 col-3">
              <p-float-label>
                <p-inputNumber
                  id="exchangeRate"
                  mode="decimal" 
                  locale="en-US"
                  [minFractionDigits]="2" 
                  [maxFractionDigits]="2"
                  [useGrouping]="false"
                  [min]="0"
                  formControlName="exchangeRate"
                  styleClass="w-full"
                />
                <label htmlFor="exchangeRate" class="text-lg font-bold text-800 required-field"> {{ labels.exchangeRate }} </label>
              </p-float-label>
            </div>
            <div class="form-group field mt-3 col-3">
              <p-float-label>
                <p-inputNumber
                  id="metricWetKilograms"
                  mode="decimal" 
                  locale="en-US"
                  [minFractionDigits]="2" 
                  [maxFractionDigits]="2"
                  [useGrouping]="false"
                  [min]="0"
                  [(ngModel)]="metricWetKilograms"
                  [ngModelOptions]="{standalone: true}"
                  styleClass="w-full"
                />
                <label htmlFor="metricWetKilograms" class="text-lg font-bold text-800 required-field"> {{ labels.metricWetKilograms }} </label>
              </p-float-label>
            </div>
            <div class="form-group field mt-3 col-3">
              <p-float-label>
                <p-inputNumber
                  id="metricWetTonnes"
                  mode="decimal" 
                  locale="en-US"
                  [minFractionDigits]="2" 
                  [maxFractionDigits]="2"
                  [useGrouping]="false"
                  [min]="0"
                  formControlName="metricWetTonnes"
                  styleClass="w-full"
                />
                <label htmlFor="metricWetTonnes" class="text-lg font-bold text-800 required-field"> {{ labels.metricWetTonnes }} </label>
              </p-float-label>
            </div>
            <div class="form-group field mt-3 col-3">
              <p-float-label>
                <p-inputNumber
                  id="humidityPercentage"
                  mode="decimal" 
                  locale="en-US"
                  [minFractionDigits]="2" 
                  [maxFractionDigits]="2"
                  [useGrouping]="false"
                  [min]="0"
                  formControlName="humidityPercentage"
                  styleClass="w-full"
                />
                <label htmlFor="humidityPercentage" class="text-lg font-bold text-800 required-field"> {{ labels.humidityPercentage }} </label>
              </p-float-label>
            </div>
          </div>
          <div class="grid">
            <table class="mt-4 w-full">
            <thead>
              <tr>
                <th class="w-4 text-lg font-semibold">Mineral</th>
                <th class="w-3 text-lg font-semibold">Precio (USD)</th>
                <th class="w-3 text-lg font-semibold">Ley</th>
                <th class="w-2 text-lg font-semibold">Sub Total (USD)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.silver }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="priceSilver"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="0"
                    formControlName="priceSilver"
                    styleClass="w-full"
                    (onInput)="calculateTotals()"
                  />
                </td>
                <td class="text-center">
                  <p-inputNumber
                    id="lawSilver"
                    [useGrouping]="false"
                    [min]="1"
                    formControlName="lawSilver"
                    styleClass="w-full"
                    (onInput)="calculateTotals()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ totalSilver | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.zinc }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="priceZinc"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="0"
                    formControlName="priceZinc"
                    styleClass="w-full"
                    (onInput)="calculateTotals()"
                  />
                </td>
                <td class="text-center">
                  <p-inputNumber
                    id="lawZinc"
                    [useGrouping]="false"
                    [min]="1"
                    formControlName="lawZinc"
                    styleClass="w-full"
                    (onInput)="calculateTotals()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ totalZinc | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.lead }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="priceLead"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="0"
                    formControlName="priceLead"
                    styleClass="w-full"
                    (onInput)="calculateTotals()"
                  />
                </td>
                <td class="text-center">
                  <p-inputNumber
                    id="lawLead"
                    [useGrouping]="false"
                    [min]="1"
                    formControlName="lawLead"
                    styleClass="w-full"
                    (onInput)="calculateTotals()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ totalLead | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td class="text-right" colspan="3">{{ labels.total }} USD</td>
                <td class="text-right">
                  {{ totalMineralsUsd | formatFieldAmount }}
                </td>
              </tr>
              <tr>
                <td class="text-right" colspan="3">{{ labels.total }} Bs</td>
                <td class="text-right">
                  {{ totalMineralsBs | formatFieldAmount }}
                </td>
              </tr>
              
            </tbody>
            </table>
          </div>
          
          <div class="grid">
            <table class="mt-4 w-full">
            <thead>
              <tr>
                <th class="w-5 text-lg font-semibold">Concepto del descuento</th>
                <th class="w-4 text-lg font-semibold">Porcentaje</th>
                <th class="w-3 text-lg font-semibold">Sub Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.rmPercentage }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="miningRoyalties"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="miningRoyalties"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ miningRoyaltiesDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.royaltySilver }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="quotationSilver"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="quotationSilver"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ quotationSilverDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.royaltyZinc }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="quotationZinc"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="quotationZinc"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ quotationZincDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.royaltyLead }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="quotationLead"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="quotationLead"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ quotationLeadDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.cajaNacional }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="cajaNacional"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="cajaNacional"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ cajaNacionalDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.fedecomin }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="fedecomin"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="fedecomin"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ fedecominDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.fencomin }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="fencomin"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="fencomin"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ fencominDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.comibol }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="comibol"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="comibol"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ comibolDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              <tr>
                <td>
                  <h4 class="text-center mr-4">{{ labels.cooperativeContribution }}</h4>
                </td>
                <td>
                  <p-inputNumber
                    id="cooperativeContribution"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="cooperativeContribution"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
                <td class="text-right">
                  <h4>{{ cooperativeContributionDiscount | formatFieldAmount }}</h4>
                </td>
              </tr>
              
              <tr>
                <td class="text-right" colspan="2">{{ labels.firstAdvance }} Bs</td>
                <td>
                  <p-inputNumber
                    id="firstAdvance"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="firstAdvance"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
              </tr>
              <tr>
                <td class="text-right" colspan="2">{{ labels.secondAdvance }} Bs</td>
                <td>
                  <p-inputNumber
                    id="secondAdvance"
                    mode="decimal" 
                    locale="en-US"
                    [minFractionDigits]="2" 
                    [maxFractionDigits]="2"
                    [useGrouping]="false"
                    [min]="limits.minPercent"
                    [max]="limits.maxPercent"
                    formControlName="secondAdvance"
                    styleClass="w-full"
                    (onInput)="calculateDiscounts()"
                  />
                </td>
              </tr>
              <tr>
                <td class="text-right" colspan="3">{{ labels.totalDiscounts }} Bs</td>
                <td class="text-right">
                  {{ totalDiscounts | formatFieldAmount }}
                </td>
              </tr>
              <tr>
                <td class="text-right" colspan="3">{{ labels.liquidPayable }} Bs</td>
                <td class="text-right">
                  {{ liquidPayableBs | formatFieldAmount }}
                </td>
              </tr>
              <tr>
                <td class="text-right" colspan="3">{{ labels.liquidPayable }} USD</td>
                <td class="text-right">
                  {{ liquidPayableUsd | formatFieldAmount }}
                </td>
              </tr>
              
            </tbody>
            </table>
          </div>
          

        </ng-template>
        <ng-template pTemplate="footer">
          <div class="p-2 pb-3">
            <button
              type="button"
              pButton pRipple
              [label]="buttons.cancel"
              icon="pi pi-times"
              severity="secondary"
              [rounded]="true"
              size="small"
              class="mr-2 shadow-3"
              (click)="hideModal()"
            ></button>
            <button
              pButton pRipple
              [label]="buttons.save"
              icon="pi pi-check"
              [rounded]="true"
              size="small"
              class="mr-2 shadow-3 hover-primary"
              (click)="saveLiquidation()"
              [disabled]="formLiquidation.invalid">
            </button>
          </div>
        </ng-template>
      </p-dialog>
    </div>
  </div>
</form>